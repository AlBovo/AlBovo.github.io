<!DOCTYPE html>
<html lang="it" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>UlisseCTF 2025 | Portfolio</title>
<meta name="keywords" content="ulissectf, ctf, binary, crypto, web, ulissectf2025">
<meta name="description" content="Una raccolta di tutte le writeup delle challenges che ho scritto per la UlisseCTF 2025.">
<meta name="author" content="AlBovo">
<link rel="canonical" href="https://albovo.github.io/it/ctf/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://albovo.github.io/en/ctf/ulissectf2025/">
<link rel="alternate" hreflang="it" href="https://albovo.github.io/it/ctf/ulissectf2025/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<meta property="og:url" content="https://albovo.github.io/it/ctf/ulissectf2025/">
  <meta property="og:site_name" content="Portfolio">
  <meta property="og:title" content="UlisseCTF 2025">
  <meta property="og:description" content="Una raccolta di tutte le writeup delle challenges che ho scritto per la UlisseCTF 2025.">
  <meta property="og:locale" content="it">
  <meta property="og:type" content="article">
    <meta property="article:section" content="ctf">
    <meta property="article:published_time" content="2025-04-08T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-04-08T00:00:00+00:00">
    <meta property="article:tag" content="Ulissectf">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Binary">
    <meta property="article:tag" content="Crypto">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="Ulissectf2025">
    <meta property="og:image" content="https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/AlBovo/CTF-Writeups">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/AlBovo/CTF-Writeups">
<meta name="twitter:title" content="UlisseCTF 2025">
<meta name="twitter:description" content="Una raccolta di tutte le writeup delle challenges che ho scritto per la UlisseCTF 2025.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Capture The Flag üö©",
      "item": "https://albovo.github.io/it/ctf/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "UlisseCTF 2025",
      "item": "https://albovo.github.io/it/ctf/ulissectf2025/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "UlisseCTF 2025",
  "name": "UlisseCTF 2025",
  "description": "Una raccolta di tutte le writeup delle challenges che ho scritto per la UlisseCTF 2025.",
  "keywords": [
    "ulissectf", "ctf", "binary", "crypto", "web", "ulissectf2025"
  ],
  "articleBody": "UlisseCTF 2025 üö© Telemetry üåê Panoramica Telemetry √® un‚Äôapplicazione web che permetteva agli utenti di caricare file (massimo 10), registrando internamente tutti gli errori e gli eventi rilevanti in file posizionati in percorsi come logs/username/user-uuid.txt.\nL‚Äôapp offriva anche un endpoint di test dei template, che consentiva agli utenti di verificare se un determinato template Jinja2 presente nella directory template potesse essere renderizzato correttamente.\nAnalisi La challenge forniva un endpoint di registrazione, dove l‚Äôutente poteva scegliere un nome utente e un nome personalizzato per il file di log. Questi valori venivano poi usati per generare un UUID che identificava in modo univoco il file di log dell‚Äôutente.\nAnalizzando le route disponibili, l‚Äôendpoint pi√π interessante era /check, che tenta di renderizzare un template Jinja2 all‚Äôinterno di un ambiente sandboxato:\n@app.route('/check', methods=['GET', 'POST']) def check(): if request.method == 'GET': return render_template('check.html') template = secure_filename(request.form['template']) if not os.path.exists(os.path.join('templates', template)): flash('Template non trovato', 'danger') return redirect('/check') try: render_template(template) flash('Template renderizzato con successo', 'success') except: flash('Errore nel rendering del template', 'danger') return redirect('/check') Tuttavia, questo endpoint non √® direttamente vulnerabile: l‚Äôuso di secure_filename e la dipendenza esclusiva da file nella directory templates/ (che l‚Äôutente non pu√≤ modificare) impedisce exploit diretti.\nUna funzione molto pi√π interessante era quella che gestiva gli errori 404, registrando gli accessi a pagine non esistenti:\n@app.errorhandler(404) def page_not_found(e): if user := session.get('user', None): if not os.path.exists(os.path.join('logs', user[1], user[0] + '.txt')): session.clear() return 'Page not found', 404 with open(os.path.join('logs', user[1], user[0] + '.txt'), 'a') as f: f.write(f'[{time.time()}] - Error at page: {unquote(request.url)}\\n') return redirect('/') return 'Page not found', 404 Questa funzione registra nel file di log dell‚Äôutente il percorso completo della URL richiesta, non codificata. Tuttavia, il percorso del log viene costruito come segue:\nos.path.join('logs', user[1], user[0] + '.txt') Se il nome utente √® una stringa di path traversal come ../, il percorso risultante sar√†:\nlogs/../.txt -\u003e .txt Questo consente effettivamente all‚Äôutente di uscire dalla directory logs/ e scrivere file in percorsi arbitrari, rendendo il sistema vulnerabile a Path Traversal e potenzialmente a Template Injection, soprattutto se quei file vengono successivamente inclusi o renderizzati dall‚Äôapplicazione.\nExploit Una volta comprese le vulnerabilit√†, la strada per l‚Äôexploit era piuttosto diretta.\nUn attaccante poteva registrarsi usando un nome utente come ../templates/ e un nome di file di log arbitrario (es. fsafsafsasfa).\nQuesto faceva s√¨ che il file di log venisse creato in:\ntemplates/.txt Poich√© l‚ÄôUUID √® derivato in modo deterministico dal nome del file di log controllato dall‚Äôattaccante, quest‚Äôultimo conosce esattamente il nome del file su cui sta scrivendo. A questo punto, l‚Äôattaccante ha realizzato un path traversal che gli permette di piazzare un file arbitrario direttamente nella directory templates/.\nSfruttamento di una SSTI Blind Con la possibilit√† di scrivere in templates/ e con l‚Äôendpoint /check che agisce da oracolo, l‚Äôattaccante pu√≤ sfruttare una Server-Side Template Injection (SSTI) blind.\nCreando payload dannosi e iniettandoli nel file di log (attraverso richieste 404), l‚Äôattaccante pu√≤ forzare il rendering inviando il nome del file all‚Äôendpoint /check.\nPer estrarre la flag, √® possibile effettuare un brute-force blind, basato su errori, carattere per carattere. Ad esempio:\n{{ 'lol' if config['FLAG'][x] == 'y' else raise('lol') }} Questo payload accede a config['FLAG'] e confronta il carattere all‚Äôindice x con il carattere ipotizzato 'y'.\nSe l‚Äôipotesi √® sbagliata, viene sollevata un‚Äôeccezione e il rendering fallisce. Se corretta, il rendering ha successo.\nIterando su ogni posizione e su tutti i caratteri stampabili, l‚Äôattaccante pu√≤ recuperare la flag usando solo il feedback di successo/fallimento.\nStackBank1 üåê Panoramica Stack Bank √® un‚Äôapplicazione web che consente agli utenti di eseguire operazioni bancarie comuni, come trasferire denaro ad altri utenti o inviare fondi direttamente all‚Äôamministratore del servizio.\nDopo aver avviato una transazione, l‚Äôutente deve attendere fino a 10 secondi per il completamento dell‚Äôoperazione. Questo ritardo √® dovuto a un bot interno che verifica asincronamente i valori e l‚Äôintegrit√† della transazione prima di segnarla come completata.\nTuttavia, c‚Äô√® un‚Äôeccezione: le transazioni verso l‚Äôamministratore vengono immediatamente marcate come completate, senza alcuna verifica o controllo di integrit√†.\nAnalisi La challenge mette a disposizione diversi servizi dietro un reverse proxy nginx configurato nel seguente modo:\nlocation /service/ { proxy_pass http://backend:4000/; ... } location / { proxy_pass http://frontend:3000; ... } Il frontend √® un‚Äôapplicazione web realizzata con Next.js, mentre il backend √® un‚Äôapplicazione Flask che espone diverse funzionalit√†. In particolare, il backend integra codice nativo C tramite CTypes, utilizzando una libreria condivisa chiamata libackend.so per implementare parte della logica principale.\nLa prima flag viene inserita nel database MongoDB durante la fase di inizializzazione del backend.\nViene memorizzata all‚Äôinterno di una transazione in cui sia il mittente che il destinatario sono l‚Äôutente administrator.\nVulnerabilit√† Poich√© la flag si trova nella transazione che coinvolge l‚Äôamministratore, pu√≤ essere utile analizzare l‚Äôendpoint presente nel frontend, nel file app/api/dashboard/route.ts. Questo file implementa il seguente codice:\nconst filter = searchParams.get(\"filter\")?.trim(); const value = searchParams.get(\"value\"); let [balance, transactions] = await Promise.all([ db.collection(\"balances\").findOne({ _id: userId }), db .collection(\"transactions\") .find({ $or: [{ sender_id: userId }, { receiver_id: userId }], }) .toArray(), ]); if ( filter \u0026\u0026 value \u0026\u0026 !filter.startsWith(\"sender\") \u0026\u0026 !filter.startsWith(\"receiver\") ) { const regex = new RegExp(`.*${escapeRegex(value)}.*`, \"i\"); transactions = await db .collection\u003cTransaction\u003e(\"transactions\") .find({ $where: function () { let t = Object.fromEntries( Object.keys(transactions).map((key) =\u003e [key, \"\"]), ); t.sender = user.username as string; t.receiver = user.username as string; for (let i = 0; i \u003c transactions.length; i++) { if (regex.test(transactions[i].note)) { t[filter] = transactions[i].note; } } return this.sender === t.sender \u0026\u0026 this.receiver === t.receiver; }, }) .toArray(); } balance = balance?.amount; return NextResponse.json({ balance, transactions }); Questa funzione √® vulnerabile perch√© un attaccante pu√≤ manipolare i valori forniti in modo che sia il mittente che il destinatario siano impostati su administrator, ottenendo cos√¨ la transazione dell‚Äôadmin contenente la flag.\nLa vulnerabilit√† deriva da un problema di prototype pollution, possibile a causa di questo frammento di codice:\nt[filter] = transactions[i].note; Un attaccante potrebbe creare un payload come:\nfilter: __proto__ nota della transazione: {'a': 'b'} Questo causerebbe la modifica dell‚Äôoggetto t tramite prototype pollution, aggiungendo ad esempio una propriet√† a (t.a = 'b'). In questo modo, l‚Äôattaccante pu√≤ alterare il comportamento dell‚Äôoggetto e accedere a dati riservati, come la flag.\nL‚Äôultimo elemento utile per completare l‚Äôexploit si trova nell‚Äôendpoint /service/transaction del backend:\n@app.route('/transaction', methods=['POST']) @login_required def transaction(user): ... # controlli di validazione omessi per brevit√† if receiver['username'] == 'administrator': return invest(user) ... # La route seguente non √® pi√π utilizzata... # @app.route('/invest', methods=['POST']) # @login_required def invest(user): amount = request.json['amount'] note = request.json['note'] mongo.db.balances.update_one( {\"user_id\": user[0]}, {\"$inc\": {\"amount\": -amount}} ) mongo.db.transactions.insert_one({ 'sender_id': user[0], 'sender': user[1], 'receiver_id': mongo.db.users.find_one({'username': 'administrator'})['_id'], 'receiver': 'administrator', 'amount': amount, 'note': note, 'status': 'success' }) return jsonify({'message': 'Investment added'}), 200 Un attaccante pu√≤ quindi inviare fondi direttamente all‚Äôaccount administrator, attivando la funzione invest che consente all‚Äôutente di specificare un campo note arbitrario (ad esempio: {'sender': 'administrator', 'receiver': 'administrator'}).\nSoluzioni unintended Mi scuso sinceramente per eventuali soluzioni unintended che potrebbero aver semplificato troppo la challenge, come l‚Äôuso di payload tipo filter=sender\u0026value=a o filter=^\u0026value=a (che mostravano tutte le transazioni nel database).\nPer il futuro, prometto di effettuare test pi√π approfonditi sulle prossime challenge, per garantire un‚Äôesperienza migliore ai partecipanti della prossima UlisseCTF ·ïô( ‚Ä¢ÃÄ ·óú ‚Ä¢ÃÅ )·ïó\nStackBank2 üåê / üñ•Ô∏è Panoramica La panoramica generale della challenge √® gi√† stata trattata nel writeup di StackBank1. Se ti interessa, dagli un‚Äôocchiata! ;)\nAnalisi La seconda flag di StackBank pu√≤ essere ottenuta diventando un ‚Äúadmin‚Äù. Questo avviene quando l‚Äôutente ha almeno 10 mila euro di saldo e invia la ADMIN_KEY corretta, che viene generata casualmente dal backend.\nA questo punto conviene analizzare la libreria libbackend.so, scritta in C e richiamata tramite ctypes. Ecco uno snippet semplificato tratto dalla libreria:\n... v16 = __readfsqword(0x28u); memset(v14, 0, sizeof(v14)); v15 = 0; dest = (char *)malloc(0x12u); strcpy(dest, a1); strncpy(v14, a9, 0x1F3u); s = (char *)malloc(0x1F4u); v13 = (char *)malloc(0x10u); strcpy(v13, \"error\"); if (a7 \u003c a8) return s; if (a8 \u003c= 0) return s; format = parse(v14); if (format) { snprintf(s, 0x1F3u, format); *(_QWORD *)v13 = 0x73736563637573LL; free(format); free(dest); } Anche se a prima vista questa funzione pu√≤ sembrare poco chiara, tutto diventa pi√π comprensibile analizzando le struct Python usate con ctypes nel file models.py:\nclass Transaction(Structure): _fields_ = [ ('sender_balance', c_int64), ('amount', c_int64), ('note', c_char_p), ] def __init__(self, id, *args, **kw): super().__init__(*args, **kw) self.id = id class Result(Structure): _fields_ = [ ('note', c_char_p), ('status', c_char_p), ] Nel contesto della challenge, la funzione C equivalente alla gestione della transazione ha questa logica:\nmemset(v7, 0, sizeof(v7)); v8 = 0; dest = (char *)malloc(0x12u); strcpy(dest, key); strncpy(v7, t.note, 0x1F3u); s = (char *)malloc(0x1F4u); s_8 = (char *)malloc(0x10u); strcpy(s_8, \"error\"); if (t.sender_balance \u003c t.amount) return s; if (t.amount \u003c= 0) return s; format = parse(v7); if (format) { snprintf(s, 0x1F3u, format); *(_QWORD *)s_8 = 'sseccus'; free(format); free(dest); } return s; Dopo aver effettuato un po‚Äô di reverse engineering, √® chiaro che la funzione parse √® sicura e non vulnerabile (lol).\nLa vera vulnerabilit√† sta nel comportamento della funzione handle_transaction: il problema √® la chiamata a snprintf, che introduce una format string vulnerability.\nUn altro comportamento importante riguarda il bot asincrono della webapp Flask. Questo bot controlla nuove transazioni ogni 10 secondi ed esegue l‚Äôelaborazione tramite la funzione C analizzata sopra.\nQuesto introduce una race condition, perch√© il bot controlla il saldo del mittente e l‚Äôimporto della transazione solo dopo che la transazione √® stata inserita nella coda.\nUn attaccante pu√≤ sfruttare questa condizione inviando rapidamente molte transazioni (es. 100 da 100‚Ç¨), raggiungendo velocemente il saldo necessario per diventare admin (10k).\nInfine, la ADMIN_KEY pu√≤ essere ottenuta inviando una stringa di formato come %6$s nel campo note di una transazione.\nQuesto permette di leggere la prima stringa presente nello stack (rsp), che corrisponde proprio alla copia della ADMIN_KEY.\nYetAnotherOracle üîë Panoramica Questa challenge forniva un oracolo che cifrava un plaintext (di almeno 32 bit) usando una chiave generata casualmente tramite il modulo random di Python, inizializzato con il valore restituito da time.time() (cio√® il timestamp dell‚Äôavvio del processo).\nLa funzione utilizzata per cifrare un plaintext con una data chiave era la seguente:\ndef mysteriousFunction(plaintext: bytes, key: bytes): a = bytes_to_long(plaintext) b = bytes_to_long(key) c, t = 0, 0 while a \u003e 0 and b \u003e 0: v1 = (a \u0026 0xf) ^ ((b \u0026 (0xff - 0xf)) \u003e\u003e 4) v2 = (b \u0026 0xf) ^ ((a \u0026 (0xff - 0xf)) \u003e\u003e 4) c += (v1 | (v2 \u003c\u003c 4)) \u003c\u003c t a, b = a \u003e\u003e 8, b \u003e\u003e 8 t += 8 if a \u003e 0: c += a \u003c\u003c t elif b \u003e 0: c += b \u003c\u003c t return long_to_bytes(c) Questa funzione lavora byte per byte, mescolando i nibble (blocchi da 4 bit) del plaintext e della chiave usando operazioni di XOR e bit shifting. Il risultato √® una combinazione ‚Äúoffuscata‚Äù dei due input.\nOltre all‚Äôoracolo, veniva anche fornita la cifratura della flag, effettuata con un‚Äôaltra chiave casuale a 32 bit.\nExploit Dato sia il plaintext che il ciphertext corrispondente, √® possibile recuperare la chiave usata durante la cifratura invertendo la logica della mysteriousFunction. Questo consente di ottenere tutti i bit della chiave, che sono stati generati dal PRNG Mersenne Twister interno di Python (random module).\nRaccogliendo abbastanza chiavi (nello specifico, 624 valori a 32 bit consecutivi), √® possibile utilizzare librerie come randcrack per ricostruire lo stato interno del PRNG.\nUna volta ottenuto lo stato interno, √® possibile anche risalire al seed originale e quindi prevedere tutti i valori futuri (e passati) generati dal modulo random.\nCon il seed recuperato, √® possibile rigenerare il valore successivo generato dal PRNG (cio√® quello usato per cifrare la flag). Usando questo valore come chiave, e invertendo la mysteriousFunction, si ottiene la flag originale.\nSoluzione Unintended La procedura sopra √® quella ‚Äúcorretta‚Äù, ma in questa challenge era anche possibile bruteforzare direttamente il seed, grazie al fatto che veniva inizializzato con time.time().\nPoich√© time.time() restituisce il numero di secondi dall‚Äôepoca Unix, lo spazio di ricerca √® molto ridotto ‚Äî specialmente se si conosce con buona approssimazione l‚Äôorario in cui √® stata avviata la challenge.\nProvando tutti i seed possibili in una finestra temporale ristretta (es. pochi minuti), si riesce a ricostruire esattamente lo stato del PRNG e a predire il valore usato per cifrare la flag, senza bisogno di raccogliere 624 output.\nx864Oracle üñ•Ô∏è Panoramica La challenge forniva un binario ELF dinamicamente linkato, assieme alla propria libc.so.6 e al linker. Una volta connessi al servizio remoto, il binario chiedeva all‚Äôutente di inserire la lunghezza del proprio nome, poi il nome stesso. L‚Äôinput veniva mostrato dopo ogni step, incluso un prompt finale che richiedeva una breve descrizione, anch‚Äôessa mostrata.\nAnalisi del Binario Il binario era stato compilato in C usando gcc, con diverse mitigazioni abilitate:\nPIE: attivo Stack canary: attivo NX (Non-Executable stack): attivo RELRO: Partial RELRO La presenza di Partial RELRO e della libc fornita fa pensare a una possibile tecnica di ret2libc, dato che la GOT √® solo parzialmente protetta.\nFunzioni rilevanti Il binario include le seguenti funzioni:\nmain readString readSize setSecurity init main() La main contiene la logica principale della challenge. In particolare, tenta ingenuamente di azzerare alcune voci della GOT per ostacolare exploit ret2libc.\ninit(argc, argv, envp); printf(\"Write the size of your name: \"); Size = readSize(v8); printf(\"You chose a name of size %s\\n\", v8); printf(\"Write your name: \"); readString(v7, Size); printf(\"Hello %s\\n\", v7); // Mapping RWX v6 = mmap(0x13370000, 0x50, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANON | MAP_PRIVATE, -1, 0); printf(\"Write a description: \"); readString(v6, 80); printf(\"Your description is: %s\\n\", v6); puts(\"Bye\"); setSecurity(); // Tentativo di wiping della GOT for (i = 0; i \u003c= 10; ++i) *(\u0026stdin + i - 14) = 0; √à interessante notare che la descrizione viene salvata in una regione di memoria mappata a un indirizzo noto (0x13370000) con permessi RWX, quindi eseguibile.\nreadString() Questa funzione legge n byte da stdin e rimuove il newline finale, se presente. Non effettua controlli rigorosi sui limiti del buffer.\nv3 = read(0, a1, a2); if (a1[v3 - 1] == '\\n') a1[v3 - 1] = 0; return a1; A seconda del contesto in cui viene chiamata, questa funzione pu√≤ essere vulnerabile a overflow.\nreadSize() Questa funzione contiene un bug interessante legato a un parsing incoerente dell‚Äôinput:\nreadString(a1, 17); if ((unsigned int)atoi(a1) \u003e 40) { puts(\"Invalid size\"); exit(0); } return strtol(a1, NULL, 0); La validazione viene fatta usando atoi (che assume base 10), mentre il valore viene poi ottenuto con strtol in base automatica (base 0). Questo apre la porta a una bypass del controllo:\n0x100 ‚Üí atoi ritorna 0 (valido), ma strtol ritorna 256 040 ‚Üí atoi ritorna 40 (valido), ma strtol ritorna 32 (ottale) 100 ‚Üí entrambi ritornano 100 (decimale) Tramite questo bug √® possibile passare una dimensione maggiore di 40 e causare buffer overflow nella funzione main.\nsetSecurity() Questa funzione imposta un filtro seccomp che blocca tutti i syscall, ad eccezione di read e write, ma solo se provengono dall‚Äôarea 0x13370000‚Äì0x13370050 (cio√® la zona dove viene scritto il payload dell‚Äôutente):\n0000: A = IP 0001: if (A \u003c 0x13370000) -\u003e ALLOW 0002: if (A \u003e= 0x13370050) -\u003e ALLOW 0003: A = syscall_num 0004: if (A == read) -\u003e ALLOW 0005: if (A == write) -\u003e ALLOW 0006: return KILL 0007: return ALLOW Nota: Non viene usato PR_SET_NO_NEW_PRIVS, rendendo il filtro meno sicuro di quanto sembri.\ninit() Imposta solo la modalit√† di buffering di stdin, stdout e stderr su unbuffered tramite setvbuf. Niente di interessante per l‚Äôexploit.\nColleghiamo i puntini üß† In sintesi, la challenge offriva:\nUn overflow di buffer sullo stack della main Un canary visibile in output (tramite null byte corrotto) Una regione RWX controllata dall‚Äôutente, a indirizzo noto Un bypass del controllo sulla dimensione dell‚Äôinput, grazie al parsing incoerente Tutto ci√≤ crea un contesto ideale per eseguire shellcode scritto nella memoria RWX.\nExploit L‚Äôexploit prevedeva i seguenti passaggi:\nLeak del canary:\nInserendo un nome con dimensione superiore al previsto (es. 0x100), si pu√≤ scrivere oltre il limite del buffer e corrompere il null byte del canary, che viene poi mostrato in output. In questo modo si ottiene il valore completo del canary.\nScrittura dello shellcode nella memoria RWX 0x13370000 tramite il campo ‚Äúdescription‚Äù.\nLo shellcode pu√≤:\nRecuperare l‚Äôindirizzo di __libc_start_main dalla stack frame Calcolare la base address di libc Calcolare l‚Äôindirizzo di system o execve Chiamare execve(\"/bin/sh\", NULL, NULL) Overflow della return address della funzione main usando il campo ‚Äúname‚Äù per sovrascrivere:\nIl padding Il canary (ora noto) I registri salvati L‚Äôindirizzo di ritorno ‚Üí 0x13370000 In questo modo, al termine della main, l‚Äôesecuzione salta alla shellcode precedentemente scritta in memoria, aggirando completamente il filtro seccomp ed eseguendo un comando arbitrario.\n",
  "wordCount" : "2733",
  "inLanguage": "it",
  "image":"https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/AlBovo/CTF-Writeups","datePublished": "2025-04-08T00:00:00Z",
  "dateModified": "2025-04-08T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "AlBovo"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://albovo.github.io/it/ctf/ulissectf2025/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Portfolio",
    "logo": {
      "@type": "ImageObject",
      "url": "https://albovo.github.io/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://albovo.github.io/it/" accesskey="h" title="Home (Alt + H)">
                <img src="https://albovo.github.io/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://albovo.github.io/en/" title="üá¨üáß En"
                            aria-label=":uk: En">üá¨üáß En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://albovo.github.io/it/projects/" title="üìí Progetti">
                    <span>üìí Progetti</span>
                </a>
            </li>
            <li>
                <a href="https://albovo.github.io/it/ctf/" title="‚öô Writeups">
                    <span>‚öô Writeups</span>
                </a>
            </li>
            <li>
                <a href="https://albovo.github.io/it/aoc/" title="üéÑ Advent of Code">
                    <span>üéÑ Advent of Code</span>
                </a>
            </li>
            <li>
                <a href="https://albovo.github.io/it/competitions/" title="üèÜ Competizioni">
                    <span>üèÜ Competizioni</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://albovo.github.io/it/">Home</a>&nbsp;¬ª&nbsp;<a href="https://albovo.github.io/it/ctf/">Capture The Flag üö©</a></div>
    <h1 class="post-title entry-hint-parent">
      UlisseCTF 2025
    </h1>
    <div class="post-description">
      Una raccolta di tutte le writeup delle challenges che ho scritto per la UlisseCTF 2025.
    </div>
    <div class="post-meta"><span title='2025-04-08 00:00:00 +0000 UTC'>aprile 8, 2025</span>&nbsp;¬∑&nbsp;13 minuti&nbsp;¬∑&nbsp;2733 parole&nbsp;¬∑&nbsp;AlBovo&nbsp;|&nbsp;Traduzioni:
<ul class="i18n_list">
    <li>
        <a href="https://albovo.github.io/en/ctf/ulissectf2025/">üá¨üáß En</a>
    </li>
</ul>&nbsp;|&nbsp;<a href="https://github.com/AlBovo/AlBovo.github.io/blob/main/content/it/ctf/UlisseCTF2025.md" rel="noopener noreferrer" target="_blank">Suggerisci modifiche</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Indice contenuti</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#telemetry-">Telemetry üåê</a>
      <ul>
        <li><a href="#panoramica">Panoramica</a></li>
        <li><a href="#analisi">Analisi</a></li>
        <li><a href="#exploit">Exploit</a></li>
      </ul>
    </li>
    <li><a href="#stackbank1-">StackBank1 üåê</a>
      <ul>
        <li><a href="#panoramica-1">Panoramica</a></li>
        <li><a href="#analisi-1">Analisi</a></li>
        <li><a href="#vulnerabilit√†">Vulnerabilit√†</a></li>
        <li><a href="#soluzioni-unintended">Soluzioni unintended</a></li>
      </ul>
    </li>
    <li><a href="#stackbank2---">StackBank2 üåê / üñ•Ô∏è</a>
      <ul>
        <li><a href="#panoramica-2">Panoramica</a></li>
        <li><a href="#analisi-2">Analisi</a></li>
      </ul>
    </li>
    <li><a href="#yetanotheroracle-">YetAnotherOracle üîë</a>
      <ul>
        <li><a href="#panoramica-3">Panoramica</a></li>
        <li><a href="#exploit-1">Exploit</a></li>
        <li><a href="#soluzione-unintended">Soluzione Unintended</a></li>
      </ul>
    </li>
    <li><a href="#x864oracle-">x864Oracle üñ•Ô∏è</a>
      <ul>
        <li><a href="#panoramica-4">Panoramica</a></li>
        <li><a href="#analisi-del-binario">Analisi del Binario</a></li>
        <li><a href="#colleghiamo-i-puntini-">Colleghiamo i puntini üß†</a></li>
        <li><a href="#exploit-2">Exploit</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="ulissectf-2025-">UlisseCTF 2025 üö©<a hidden class="anchor" aria-hidden="true" href="#ulissectf-2025-">#</a></h1>
<p><img alt="ulisse logo" loading="lazy" src="/images/ulisse.png"></p>
<h2 id="telemetry-">Telemetry üåê<a hidden class="anchor" aria-hidden="true" href="#telemetry-">#</a></h2>
<h3 id="panoramica">Panoramica<a hidden class="anchor" aria-hidden="true" href="#panoramica">#</a></h3>
<p><strong>Telemetry</strong> √® un&rsquo;applicazione web che permetteva agli utenti di caricare file (massimo 10), registrando internamente tutti gli errori e gli eventi rilevanti in file posizionati in percorsi come <code>logs/username/user-uuid.txt</code>.</p>
<p>L&rsquo;app offriva anche un endpoint di test dei template, che consentiva agli utenti di verificare se un determinato <strong>template Jinja2</strong> presente nella directory <code>template</code> potesse essere renderizzato correttamente.</p>
<h3 id="analisi">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi">#</a></h3>
<p>La challenge forniva un endpoint di <strong>registrazione</strong>, dove l‚Äôutente poteva scegliere un nome utente e un <strong>nome personalizzato per il file di log</strong>. Questi valori venivano poi usati per generare un <code>UUID</code> che identificava in modo univoco il file di log dell‚Äôutente.</p>
<p>Analizzando le route disponibili, l‚Äôendpoint pi√π interessante era <code>/check</code>, che tenta di renderizzare un template Jinja2 all‚Äôinterno di un <strong>ambiente sandboxato</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;check.html&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">template</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;templates&#39;</span><span class="p">,</span> <span class="n">template</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Template non trovato&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Template renderizzato con successo&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Errore nel rendering del template&#39;</span><span class="p">,</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/check&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Tuttavia, questo endpoint <strong>non √® direttamente vulnerabile</strong>: l‚Äôuso di <code>secure_filename</code> e la dipendenza esclusiva da file nella directory <code>templates/</code> (che l‚Äôutente non pu√≤ modificare) impedisce exploit diretti.</p>
<p>Una funzione molto pi√π interessante era quella che gestiva gli <strong>errori 404</strong>, registrando gli accessi a pagine non esistenti:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">user</span> <span class="o">:=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;Page not found&#39;</span><span class="p">,</span> <span class="mi">404</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s1">] - Error at page: </span><span class="si">{</span><span class="n">unquote</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;Page not found&#39;</span><span class="p">,</span> <span class="mi">404</span>
</span></span></code></pre></div><p>Questa funzione registra nel file di log dell‚Äôutente il percorso completo della URL richiesta, <strong>non codificata</strong>. Tuttavia, il percorso del log viene costruito come segue:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Se il <strong>nome utente</strong> √® una stringa di path traversal come <code>../</code>, il percorso risultante sar√†:</p>
<pre tabindex="0"><code>logs/../&lt;uuid&gt;.txt -&gt; &lt;uuid&gt;.txt
</code></pre><p>Questo consente effettivamente all‚Äôutente di <strong>uscire dalla directory <code>logs/</code></strong> e scrivere file in percorsi arbitrari, rendendo il sistema vulnerabile a <strong>Path Traversal</strong> e potenzialmente a <strong>Template Injection</strong>, soprattutto se quei file vengono successivamente inclusi o renderizzati dall&rsquo;applicazione.</p>
<h3 id="exploit">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h3>
<p>Una volta comprese le vulnerabilit√†, la strada per l‚Äôexploit era piuttosto diretta.<br>
Un attaccante poteva registrarsi usando un <strong>nome utente</strong> come <code>../templates/</code> e un nome di file di log arbitrario (es. <code>fsafsafsasfa</code>).</p>
<p>Questo faceva s√¨ che il file di log venisse creato in:</p>
<pre tabindex="0"><code>templates/&lt;uuid&gt;.txt
</code></pre><p>Poich√© l‚Äô<code>UUID</code> √® derivato in modo deterministico dal nome del file di log controllato dall‚Äôattaccante, quest‚Äôultimo <strong>conosce esattamente il nome</strong> del file su cui sta scrivendo. A questo punto, l‚Äôattaccante ha realizzato un <strong>path traversal</strong> che gli permette di piazzare un file arbitrario direttamente nella directory <code>templates/</code>.</p>
<h4 id="sfruttamento-di-una-ssti-blind">Sfruttamento di una SSTI Blind<a hidden class="anchor" aria-hidden="true" href="#sfruttamento-di-una-ssti-blind">#</a></h4>
<p>Con la possibilit√† di scrivere in <code>templates/</code> e con l‚Äôendpoint <code>/check</code> che agisce da <strong>oracolo</strong>, l‚Äôattaccante pu√≤ sfruttare una <strong>Server-Side Template Injection (SSTI) blind</strong>.</p>
<p>Creando payload dannosi e iniettandoli nel file di log (attraverso richieste 404), l‚Äôattaccante pu√≤ forzare il rendering inviando il nome del file all‚Äôendpoint <code>/check</code>.</p>
<p>Per estrarre la flag, √® possibile effettuare un <strong>brute-force blind, basato su errori, carattere per carattere</strong>. Ad esempio:</p>
<pre tabindex="0"><code class="language-jinja2" data-lang="jinja2">{{ &#39;lol&#39; if config[&#39;FLAG&#39;][x] == &#39;y&#39; else raise(&#39;lol&#39;) }}
</code></pre><p>Questo payload accede a <code>config['FLAG']</code> e confronta il carattere all‚Äôindice <code>x</code> con il carattere ipotizzato <code>'y'</code>.<br>
Se l‚Äôipotesi √® sbagliata, viene sollevata un‚Äôeccezione e il rendering fallisce. Se corretta, il rendering ha successo.</p>
<p>Iterando su ogni posizione e su tutti i caratteri stampabili, l‚Äôattaccante pu√≤ recuperare la flag <strong>usando solo il feedback di successo/fallimento</strong>.</p>
<h2 id="stackbank1-">StackBank1 üåê<a hidden class="anchor" aria-hidden="true" href="#stackbank1-">#</a></h2>
<h3 id="panoramica-1">Panoramica<a hidden class="anchor" aria-hidden="true" href="#panoramica-1">#</a></h3>
<p><strong>Stack Bank</strong> √® un&rsquo;applicazione web che consente agli utenti di eseguire operazioni bancarie comuni, come trasferire denaro ad altri utenti o inviare fondi direttamente all‚Äô<strong>amministratore</strong> del servizio.</p>
<p>Dopo aver avviato una transazione, l‚Äôutente deve attendere fino a <strong>10 secondi</strong> per il completamento dell‚Äôoperazione. Questo ritardo √® dovuto a un <strong>bot interno</strong> che verifica asincronamente i valori e l‚Äôintegrit√† della transazione prima di segnarla come completata.</p>
<p>Tuttavia, c‚Äô√® un‚Äôeccezione: le <strong>transazioni verso l‚Äôamministratore</strong> vengono immediatamente marcate come completate, senza alcuna verifica o controllo di integrit√†.</p>
<h3 id="analisi-1">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-1">#</a></h3>
<p>La challenge mette a disposizione diversi servizi dietro un reverse proxy <code>nginx</code> configurato nel seguente modo:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">location</span> <span class="s">/service/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_pass</span> <span class="s">http://backend:4000/</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">...</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_pass</span> <span class="s">http://frontend:3000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">...</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span></code></pre></div><p>Il <strong>frontend</strong> √® un‚Äôapplicazione web realizzata con <strong>Next.js</strong>, mentre il <strong>backend</strong> √® un‚Äôapplicazione <strong>Flask</strong> che espone diverse funzionalit√†. In particolare, il backend integra codice nativo C tramite <strong>CTypes</strong>, utilizzando una libreria condivisa chiamata <code>libackend.so</code> per implementare parte della logica principale.</p>
<p>La prima flag viene inserita nel database <strong>MongoDB</strong> durante la fase di inizializzazione del backend.<br>
Viene memorizzata all‚Äôinterno di una <strong>transazione</strong> in cui sia il <strong>mittente</strong> che il <strong>destinatario</strong> sono l‚Äôutente <code>administrator</code>.</p>
<h3 id="vulnerabilit√†">Vulnerabilit√†<a hidden class="anchor" aria-hidden="true" href="#vulnerabilit√†">#</a></h3>
<p>Poich√© la flag si trova nella transazione che coinvolge l‚Äôamministratore, pu√≤ essere utile analizzare l‚Äôendpoint presente nel frontend, nel file <code>app/api/dashboard/route.ts</code>. Questo file implementa il seguente codice:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">filter</span> <span class="o">=</span> <span class="nx">searchParams</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s2">&#34;filter&#34;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">searchParams</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s2">&#34;value&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="p">[</span><span class="nx">balance</span><span class="p">,</span> <span class="nx">transactions</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&#34;balances&#34;</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">_id</span>: <span class="kt">userId</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">db</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s2">&#34;transactions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">find</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">$or</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">sender_id</span>: <span class="kt">userId</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">receiver_id</span>: <span class="kt">userId</span> <span class="p">}],</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">toArray</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">filter</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">value</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">    <span class="o">!</span><span class="nx">filter</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;sender&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">    <span class="o">!</span><span class="nx">filter</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;receiver&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">regex</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="sb">`.*</span><span class="si">${</span><span class="nx">escapeRegex</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span><span class="sb">.*`</span><span class="p">,</span> <span class="s2">&#34;i&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">transactions</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">collection</span><span class="p">&lt;</span><span class="nt">Transaction</span><span class="p">&gt;(</span><span class="s2">&#34;transactions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">find</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">$where</span>: <span class="kt">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">transactions</span><span class="p">).</span><span class="nx">map</span><span class="p">((</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">t</span><span class="p">.</span><span class="nx">sender</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t</span><span class="p">.</span><span class="nx">receiver</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span> <span class="kr">as</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">transactions</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">transactions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">note</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">t</span><span class="p">[</span><span class="nx">filter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">transactions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">note</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">sender</span> <span class="o">===</span> <span class="nx">t</span><span class="p">.</span><span class="nx">sender</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">receiver</span> <span class="o">===</span> <span class="nx">t</span><span class="p">.</span><span class="nx">receiver</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">toArray</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">balance</span> <span class="o">=</span> <span class="nx">balance</span><span class="o">?</span><span class="p">.</span><span class="nx">amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">balance</span><span class="p">,</span> <span class="nx">transactions</span> <span class="p">});</span>
</span></span></code></pre></div><p>Questa funzione √® <strong>vulnerabile</strong> perch√© un attaccante pu√≤ manipolare i valori forniti in modo che sia il <strong>mittente</strong> che il <strong>destinatario</strong> siano impostati su <code>administrator</code>, ottenendo cos√¨ la <strong>transazione dell‚Äôadmin</strong> contenente la flag.</p>
<p>La vulnerabilit√† deriva da un problema di <strong>prototype pollution</strong>, possibile a causa di questo frammento di codice:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">t</span><span class="p">[</span><span class="nx">filter</span><span class="p">]</span> <span class="o">=</span> <span class="nx">transactions</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">note</span><span class="p">;</span>
</span></span></code></pre></div><p>Un attaccante potrebbe creare un payload come:</p>
<ul>
<li><strong>filter</strong>: <code>__proto__</code></li>
<li><strong>nota della transazione</strong>: <code>{'a': 'b'}</code></li>
</ul>
<p>Questo causerebbe la modifica dell‚Äôoggetto <code>t</code> tramite prototype pollution, aggiungendo ad esempio una propriet√† <code>a</code> (<code>t.a = 'b'</code>). In questo modo, l‚Äôattaccante pu√≤ alterare il comportamento dell‚Äôoggetto e accedere a dati riservati, come la flag.</p>
<p>L‚Äôultimo elemento utile per completare l‚Äôexploit si trova nell‚Äôendpoint <code>/service/transaction</code> del backend:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/transaction&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nd">@login_required</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># controlli di validazione omessi per brevit√†</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">receiver</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;administrator&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">invest</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># La route seguente non √® pi√π utilizzata...</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @app.route(&#39;/invest&#39;, methods=[&#39;POST&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="c1"># @login_required</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">invest</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">amount</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">note</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;note&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">balances</span><span class="o">.</span><span class="n">update_one</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;user_id&#34;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;$inc&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;amount&#34;</span><span class="p">:</span> <span class="o">-</span><span class="n">amount</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transactions</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;sender_id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;sender&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;receiver_id&#39;</span><span class="p">:</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;administrator&#39;</span><span class="p">})[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;receiver&#39;</span><span class="p">:</span> <span class="s1">&#39;administrator&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;note&#39;</span><span class="p">:</span> <span class="n">note</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Investment added&#39;</span><span class="p">}),</span> <span class="mi">200</span>
</span></span></code></pre></div><p>Un attaccante pu√≤ quindi inviare fondi direttamente all‚Äôaccount <code>administrator</code>, attivando la funzione <code>invest</code> che consente all‚Äôutente di specificare un campo <code>note</code> arbitrario (ad esempio: <code>{'sender': 'administrator', 'receiver': 'administrator'}</code>).</p>
<h3 id="soluzioni-unintended">Soluzioni unintended<a hidden class="anchor" aria-hidden="true" href="#soluzioni-unintended">#</a></h3>
<p>Mi scuso sinceramente per eventuali soluzioni unintended che potrebbero aver semplificato troppo la challenge, come l‚Äôuso di payload tipo <code>filter=sender&amp;value=a</code> o <code>filter=^&amp;value=a</code> (che mostravano tutte le transazioni nel database).<br>
Per il futuro, prometto di effettuare test pi√π approfonditi sulle prossime challenge, per garantire un‚Äôesperienza migliore ai partecipanti della prossima UlisseCTF <strong><code>·ïô(  ‚Ä¢ÃÄ ·óú ‚Ä¢ÃÅ  )·ïó</code></strong></p>
<h2 id="stackbank2---">StackBank2 üåê / üñ•Ô∏è<a hidden class="anchor" aria-hidden="true" href="#stackbank2---">#</a></h2>
<h3 id="panoramica-2">Panoramica<a hidden class="anchor" aria-hidden="true" href="#panoramica-2">#</a></h3>
<p>La panoramica generale della challenge √® gi√† stata trattata nel writeup di StackBank1. Se ti interessa, dagli un‚Äôocchiata! ;)</p>
<h3 id="analisi-2">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-2">#</a></h3>
<p>La seconda flag di StackBank pu√≤ essere ottenuta diventando un &ldquo;admin&rdquo;. Questo avviene quando l‚Äôutente ha almeno <strong>10 mila</strong> euro di saldo e invia la <code>ADMIN_KEY</code> corretta, che viene generata casualmente dal backend.</p>
<p>A questo punto conviene analizzare la libreria <code>libbackend.so</code>, scritta in <strong>C</strong> e richiamata tramite <strong>ctypes</strong>. Ecco uno snippet semplificato tratto dalla libreria:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">v16</span> <span class="o">=</span> <span class="nf">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">memset</span><span class="p">(</span><span class="n">v14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v14</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">v15</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x12u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">strcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">a1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">strncpy</span><span class="p">(</span><span class="n">v14</span><span class="p">,</span> <span class="n">a9</span><span class="p">,</span> <span class="mh">0x1F3u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x1F4u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">v13</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x10u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">strcpy</span><span class="p">(</span><span class="n">v13</span><span class="p">,</span> <span class="s">&#34;error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">a7</span> <span class="o">&lt;</span> <span class="n">a8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">a8</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">format</span> <span class="o">=</span> <span class="nf">parse</span><span class="p">(</span><span class="n">v14</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mh">0x1F3u</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v13</span> <span class="o">=</span> <span class="mh">0x73736563637573LL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Anche se a prima vista questa funzione pu√≤ sembrare poco chiara, tutto diventa pi√π comprensibile analizzando le struct Python usate con <strong>ctypes</strong> nel file <code>models.py</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Transaction</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s1">&#39;sender_balance&#39;</span><span class="p">,</span> <span class="n">c_int64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="n">c_int64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Result</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span></code></pre></div><p>Nel contesto della challenge, la funzione C equivalente alla gestione della transazione ha questa logica:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">memset</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v7</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">v8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x12u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">strcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">strncpy</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">note</span><span class="p">,</span> <span class="mh">0x1F3u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x1F4u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">s_8</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x10u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">strcpy</span><span class="p">(</span><span class="n">s_8</span><span class="p">,</span> <span class="s">&#34;error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">sender_balance</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">format</span> <span class="o">=</span> <span class="nf">parse</span><span class="p">(</span><span class="n">v7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">snprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mh">0x1F3u</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">s_8</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">sseccus</span><span class="err">&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span></code></pre></div><p>Dopo aver effettuato un po‚Äô di reverse engineering, √® chiaro che la funzione <code>parse</code> <strong>√® sicura e non vulnerabile</strong> (lol).<br>
La vera vulnerabilit√† sta nel comportamento della funzione <code>handle_transaction</code>: il problema √® la chiamata a <code>snprintf</code>, che introduce una <strong>format string vulnerability</strong>.</p>
<p>Un altro comportamento importante riguarda il bot asincrono della webapp Flask. Questo bot controlla nuove transazioni ogni 10 secondi ed esegue l‚Äôelaborazione tramite la funzione C analizzata sopra.<br>
Questo introduce una <strong>race condition</strong>, perch√© il bot controlla il saldo del mittente e l‚Äôimporto della transazione <strong>solo dopo</strong> che la transazione √® stata inserita nella coda.<br>
Un attaccante pu√≤ sfruttare questa condizione inviando rapidamente molte transazioni (es. 100 da 100‚Ç¨), raggiungendo velocemente il saldo necessario per diventare admin (10k).</p>
<p>Infine, la <code>ADMIN_KEY</code> pu√≤ essere ottenuta inviando una stringa di formato come <code>%6$s</code> nel campo <code>note</code> di una transazione.<br>
Questo permette di leggere la <strong>prima stringa presente nello stack (rsp)</strong>, che corrisponde proprio alla copia della <code>ADMIN_KEY</code>.</p>
<h2 id="yetanotheroracle-">YetAnotherOracle üîë<a hidden class="anchor" aria-hidden="true" href="#yetanotheroracle-">#</a></h2>
<h3 id="panoramica-3">Panoramica<a hidden class="anchor" aria-hidden="true" href="#panoramica-3">#</a></h3>
<p>Questa challenge forniva un <em>oracolo</em> che cifrava un plaintext (di almeno 32 bit) usando una chiave generata casualmente tramite il modulo <code>random</code> di Python, inizializzato con il valore restituito da <code>time.time()</code> (cio√® il timestamp dell&rsquo;avvio del processo).</p>
<p>La funzione utilizzata per cifrare un plaintext con una data chiave era la seguente:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mysteriousFunction</span><span class="p">(</span><span class="n">plaintext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">a</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0xf</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">a</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xff</span> <span class="o">-</span> <span class="mh">0xf</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">+=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">|</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span> <span class="o">+=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">+=</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="o">+=</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span></code></pre></div><p>Questa funzione lavora byte per byte, mescolando i <em>nibble</em> (blocchi da 4 bit) del plaintext e della chiave usando operazioni di <strong>XOR</strong> e <strong>bit shifting</strong>. Il risultato √® una combinazione &ldquo;offuscata&rdquo; dei due input.</p>
<p>Oltre all&rsquo;oracolo, veniva anche fornita la cifratura della flag, effettuata con un‚Äôaltra chiave casuale a 32 bit.</p>
<h3 id="exploit-1">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit-1">#</a></h3>
<p>Dato sia il plaintext che il ciphertext corrispondente, √® possibile <strong>recuperare la chiave</strong> usata durante la cifratura invertendo la logica della <code>mysteriousFunction</code>. Questo consente di ottenere <strong>tutti i bit della chiave</strong>, che sono stati generati dal PRNG <strong>Mersenne Twister</strong> interno di Python (<code>random</code> module).</p>
<p>Raccogliendo abbastanza chiavi (nello specifico, <strong>624 valori a 32 bit consecutivi</strong>), √® possibile utilizzare librerie come <a href="https://github.com/tna0y/Python-random-module-cracker"><code>randcrack</code></a> per <strong>ricostruire lo stato interno del PRNG</strong>.<br>
Una volta ottenuto lo stato interno, √® possibile anche risalire al seed originale e quindi prevedere tutti i valori futuri (e passati) generati dal modulo <code>random</code>.</p>
<p>Con il seed recuperato, √® possibile rigenerare il valore successivo generato dal PRNG (cio√® quello usato per cifrare la flag). Usando questo valore come chiave, e invertendo la <code>mysteriousFunction</code>, si ottiene la <strong>flag originale</strong>.</p>
<h3 id="soluzione-unintended">Soluzione Unintended<a hidden class="anchor" aria-hidden="true" href="#soluzione-unintended">#</a></h3>
<p>La procedura sopra √® quella ‚Äúcorretta‚Äù, ma in questa challenge era anche possibile <strong>bruteforzare direttamente il seed</strong>, grazie al fatto che veniva inizializzato con <code>time.time()</code>.<br>
Poich√© <code>time.time()</code> restituisce il numero di secondi dall‚Äôepoca Unix, lo <strong>spazio di ricerca √® molto ridotto</strong> ‚Äî specialmente se si conosce con buona approssimazione l‚Äôorario in cui √® stata avviata la challenge.</p>
<p>Provando tutti i seed possibili in una finestra temporale ristretta (es. pochi minuti), si riesce a ricostruire <strong>esattamente</strong> lo stato del PRNG e a predire il valore usato per cifrare la flag, senza bisogno di raccogliere 624 output.</p>
<h2 id="x864oracle-">x864Oracle üñ•Ô∏è<a hidden class="anchor" aria-hidden="true" href="#x864oracle-">#</a></h2>
<h3 id="panoramica-4">Panoramica<a hidden class="anchor" aria-hidden="true" href="#panoramica-4">#</a></h3>
<p>La challenge forniva un binario ELF dinamicamente linkato, assieme alla propria <code>libc.so.6</code> e al linker. Una volta connessi al servizio remoto, il binario chiedeva all‚Äôutente di inserire la lunghezza del proprio nome, poi il nome stesso. L‚Äôinput veniva mostrato dopo ogni step, incluso un prompt finale che richiedeva una breve descrizione, anch‚Äôessa mostrata.</p>
<h3 id="analisi-del-binario">Analisi del Binario<a hidden class="anchor" aria-hidden="true" href="#analisi-del-binario">#</a></h3>
<p>Il binario era stato compilato in C usando <code>gcc</code>, con diverse mitigazioni abilitate:</p>
<ul>
<li><strong>PIE</strong>: attivo</li>
<li><strong>Stack canary</strong>: attivo</li>
<li><strong>NX (Non-Executable stack)</strong>: attivo</li>
<li><strong>RELRO</strong>: <em>Partial RELRO</em></li>
</ul>
<p>La presenza di Partial RELRO e della <code>libc</code> fornita fa pensare a una possibile tecnica di <strong>ret2libc</strong>, dato che la GOT √® solo parzialmente protetta.</p>
<h4 id="funzioni-rilevanti">Funzioni rilevanti<a hidden class="anchor" aria-hidden="true" href="#funzioni-rilevanti">#</a></h4>
<p>Il binario include le seguenti funzioni:</p>
<ul>
<li><code>main</code></li>
<li><code>readString</code></li>
<li><code>readSize</code></li>
<li><code>setSecurity</code></li>
<li><code>init</code></li>
</ul>
<h4 id="main">main()<a hidden class="anchor" aria-hidden="true" href="#main">#</a></h4>
<p>La <code>main</code> contiene la logica principale della challenge. In particolare, tenta ingenuamente di azzerare alcune voci della GOT per ostacolare exploit <code>ret2libc</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Write the size of your name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Size</span> <span class="o">=</span> <span class="nf">readSize</span><span class="p">(</span><span class="n">v8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">printf</span><span class="p">(</span><span class="s">&#34;You chose a name of size %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Write your name: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">readString</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Hello %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Mapping RWX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">v6</span> <span class="o">=</span> <span class="nf">mmap</span><span class="p">(</span><span class="mh">0x13370000</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span> <span class="n">MAP_ANON</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Write a description: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">readString</span><span class="p">(</span><span class="n">v6</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Your description is: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">v6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Bye&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">setSecurity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Tentativo di wiping della GOT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stdin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></div><p>√à interessante notare che la descrizione viene salvata in una regione di memoria mappata a un indirizzo noto (<code>0x13370000</code>) con permessi <strong>RWX</strong>, quindi <strong>eseguibile</strong>.</p>
<h4 id="readstring">readString()<a hidden class="anchor" aria-hidden="true" href="#readstring">#</a></h4>
<p>Questa funzione legge <code>n</code> byte da <code>stdin</code> e rimuove il newline finale, se presente. Non effettua controlli rigorosi sui limiti del buffer.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">v3</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">a1</span><span class="p">[</span><span class="n">v3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">a1</span><span class="p">[</span><span class="n">v3</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">a1</span><span class="p">;</span>
</span></span></code></pre></div><p>A seconda del contesto in cui viene chiamata, questa funzione pu√≤ essere vulnerabile a overflow.</p>
<h4 id="readsize">readSize()<a hidden class="anchor" aria-hidden="true" href="#readsize">#</a></h4>
<p>Questa funzione contiene un bug interessante legato a un parsing incoerente dell‚Äôinput:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">readString</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="nf">atoi</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Invalid size&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nf">strtol</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span></code></pre></div><p>La validazione viene fatta usando <code>atoi</code> (che assume <strong>base 10</strong>), mentre il valore viene poi ottenuto con <code>strtol</code> in <strong>base automatica</strong> (base 0). Questo apre la porta a una <strong>bypass del controllo</strong>:</p>
<ul>
<li><code>0x100</code> ‚Üí <code>atoi</code> ritorna 0 (valido), ma <code>strtol</code> ritorna 256</li>
<li><code>040</code>   ‚Üí <code>atoi</code> ritorna 40 (valido), ma <code>strtol</code> ritorna 32 (ottale)</li>
<li><code>100</code>   ‚Üí entrambi ritornano 100 (decimale)</li>
</ul>
<p>Tramite questo bug √® possibile passare una dimensione maggiore di 40 e causare <strong>buffer overflow</strong> nella funzione <code>main</code>.</p>
<h4 id="setsecurity">setSecurity()<a hidden class="anchor" aria-hidden="true" href="#setsecurity">#</a></h4>
<p>Questa funzione imposta un filtro <strong>seccomp</strong> che <strong>blocca tutti i syscall</strong>, ad eccezione di <code>read</code> e <code>write</code>, ma solo se provengono dall‚Äôarea <code>0x13370000‚Äì0x13370050</code> (cio√® la zona dove viene scritto il payload dell‚Äôutente):</p>
<pre tabindex="0"><code> 0000: A = IP
 0001: if (A &lt; 0x13370000) -&gt; ALLOW
 0002: if (A &gt;= 0x13370050) -&gt; ALLOW
 0003: A = syscall_num
 0004: if (A == read)  -&gt; ALLOW
 0005: if (A == write) -&gt; ALLOW
 0006: return KILL
 0007: return ALLOW
</code></pre><p><strong>Nota:</strong> Non viene usato <code>PR_SET_NO_NEW_PRIVS</code>, rendendo il filtro meno sicuro di quanto sembri.</p>
<h4 id="init">init()<a hidden class="anchor" aria-hidden="true" href="#init">#</a></h4>
<p>Imposta solo la modalit√† di buffering di <code>stdin</code>, <code>stdout</code> e <code>stderr</code> su <em>unbuffered</em> tramite <code>setvbuf</code>. Niente di interessante per l‚Äôexploit.</p>
<h3 id="colleghiamo-i-puntini-">Colleghiamo i puntini üß†<a hidden class="anchor" aria-hidden="true" href="#colleghiamo-i-puntini-">#</a></h3>
<p>In sintesi, la challenge offriva:</p>
<ul>
<li>Un <strong>overflow di buffer</strong> sullo stack della <code>main</code></li>
<li>Un <strong>canary</strong> visibile in output (tramite null byte corrotto)</li>
<li>Una regione RWX controllata dall‚Äôutente, a indirizzo noto</li>
<li>Un <strong>bypass</strong> del controllo sulla dimensione dell‚Äôinput, grazie al parsing incoerente</li>
</ul>
<p>Tutto ci√≤ crea un contesto ideale per eseguire <strong>shellcode</strong> scritto nella memoria RWX.</p>
<h3 id="exploit-2">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit-2">#</a></h3>
<p>L‚Äôexploit prevedeva i seguenti passaggi:</p>
<ol>
<li>
<p><strong>Leak del canary</strong>:<br>
Inserendo un nome con dimensione superiore al previsto (es. <code>0x100</code>), si pu√≤ scrivere oltre il limite del buffer e <strong>corrompere il null byte</strong> del canary, che viene poi mostrato in output. In questo modo si ottiene il valore completo del canary.</p>
</li>
<li>
<p><strong>Scrittura dello shellcode</strong> nella memoria RWX <code>0x13370000</code> tramite il campo ‚Äúdescription‚Äù.<br>
Lo shellcode pu√≤:</p>
<ul>
<li>Recuperare l‚Äôindirizzo di <code>__libc_start_main</code> dalla stack frame</li>
<li>Calcolare la base address di <code>libc</code></li>
<li>Calcolare l‚Äôindirizzo di <code>system</code> o <code>execve</code></li>
<li>Chiamare <code>execve(&quot;/bin/sh&quot;, NULL, NULL)</code></li>
</ul>
</li>
<li>
<p><strong>Overflow della return address</strong> della funzione <code>main</code> usando il campo ‚Äúname‚Äù per sovrascrivere:</p>
<ul>
<li>Il padding</li>
<li>Il canary (ora noto)</li>
<li>I registri salvati</li>
<li>L‚Äôindirizzo di ritorno ‚Üí <code>0x13370000</code></li>
</ul>
</li>
</ol>
<p>In questo modo, al termine della <code>main</code>, l‚Äôesecuzione salta alla shellcode precedentemente scritta in memoria, aggirando completamente il filtro seccomp ed eseguendo un <strong>comando arbitrario</strong>.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://albovo.github.io/it/tags/ulissectf/">Ulissectf</a></li>
      <li><a href="https://albovo.github.io/it/tags/ctf/">Ctf</a></li>
      <li><a href="https://albovo.github.io/it/tags/binary/">Binary</a></li>
      <li><a href="https://albovo.github.io/it/tags/crypto/">Crypto</a></li>
      <li><a href="https://albovo.github.io/it/tags/web/">Web</a></li>
      <li><a href="https://albovo.github.io/it/tags/ulissectf2025/">Ulissectf2025</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://albovo.github.io/it/ctf/enowars2025/">
    <span class="title">¬´ Precedente</span>
    <br>
    <span>ENOWARS 9</span>
  </a>
  <a class="next" href="https://albovo.github.io/it/ctf/pascalctf2025/">
    <span class="title">Successivo ¬ª</span>
    <br>
    <span>Pascal CTF Beginner 2025</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UlisseCTF 2025 on x"
            href="https://x.com/intent/tweet/?text=UlisseCTF%202025&amp;url=https%3a%2f%2falbovo.github.io%2fit%2fctf%2fulissectf2025%2f&amp;hashtags=ulissectf%2cctf%2cbinary%2ccrypto%2cweb%2culissectf2025">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UlisseCTF 2025 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2falbovo.github.io%2fit%2fctf%2fulissectf2025%2f&amp;title=UlisseCTF%202025&amp;summary=UlisseCTF%202025&amp;source=https%3a%2f%2falbovo.github.io%2fit%2fctf%2fulissectf2025%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UlisseCTF 2025 on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2falbovo.github.io%2fit%2fctf%2fulissectf2025%2f&title=UlisseCTF%202025">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UlisseCTF 2025 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2falbovo.github.io%2fit%2fctf%2fulissectf2025%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UlisseCTF 2025 on whatsapp"
            href="https://api.whatsapp.com/send?text=UlisseCTF%202025%20-%20https%3a%2f%2falbovo.github.io%2fit%2fctf%2fulissectf2025%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UlisseCTF 2025 on telegram"
            href="https://telegram.me/share/url?text=UlisseCTF%202025&amp;url=https%3a%2f%2falbovo.github.io%2fit%2fctf%2fulissectf2025%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share UlisseCTF 2025 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=UlisseCTF%202025&u=https%3a%2f%2falbovo.github.io%2fit%2fctf%2fulissectf2025%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://albovo.github.io/it/">Portfolio</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
